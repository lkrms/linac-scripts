#!/bin/bash
# shellcheck disable=SC2206,SC2207

if ! command_exists brew; then

    ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)" || die

fi

function brew_check_taps() {

    local MISSING_TAPS TAP

    MISSING_TAPS=($(comm -23 <(printf '%s\n' "${BREW_TAPS[@]}" | sort | uniq) <(brew tap | sort | uniq)))

    if [ "${#MISSING_TAPS[@]}" -gt "0" ]; then

        console_message "Adding ${#MISSING_TAPS[@]} Homebrew $(single_or_plural "${#MISSING_TAPS[@]}" tap taps):" "${MISSING_TAPS[*]}" "$GREEN"

        for TAP in "${MISSING_TAPS[@]}"; do

            brew tap "$TAP" || die

        done

        [ "$BREW_CACHE_DIRTY" -ne "0" ] || brew_refresh

    fi

}

function brew_refresh() {

    BREW_INSTALLED_FORMULAE="$(brew list | sort | uniq)" || die
    BREW_AVAILABLE_FORMULAE="$(brew search | sort | uniq)" || die
    BREW_INSTALLED_CASKS="$(brew cask list | sort | uniq)" || die
    BREW_AVAILABLE_CASKS="$(brew search --casks | sort | uniq)" || die

}

function brew_formula_installed() {

    brew_make_cache_clean
    echo "$BREW_INSTALLED_FORMULAE" | grep -E '^'"$1"'$' >/dev/null 2>&1

}

function brew_formula_available() {

    brew_make_cache_clean
    echo "$BREW_AVAILABLE_FORMULAE" | grep -E '^'"$1"'$' >/dev/null 2>&1

}

function brew_mark_cache_clean() {

    [ "$BREW_CACHE_DIRTY" -ne "0" ] && brew_refresh && BREW_CACHE_DIRTY=0

}

function brew_make_cache_clean() {

    if [ "$BREW_CACHE_DIRTY" -ne "0" ]; then

        console_message "Updating lists..." "" "$CYAN"

        brew update && brew_refresh && BREW_CACHE_DIRTY=0 || die

    fi

}

# Usage: brew_install_formulae "Description of this group of formulae" "formula1 formula2 ..." [allow user override? (Y/n)]
function brew_install_formulae() {

    local REQUESTED=($2) UI="${3:-Y}" INSTALL UNAVAILABLE

    brew_make_cache_clean

    console_message "Checking $1..." "" "$CYAN"

    INSTALL=($(comm -23 <(printf '%s\n' "${REQUESTED[@]}" | sort | uniq) <(printf '%s\n' "${BREW_INSTALLED_FORMULAE[@]}")))
    BREW_INSTALLED+=($(comm -12 <(printf '%s\n' "${REQUESTED[@]}" | sort | uniq) <(printf '%s\n' "${BREW_INSTALLED_FORMULAE[@]}")))

    if [ "${#INSTALL[@]}" -gt "0" ]; then

        UNAVAILABLE=($(comm -23 <(printf '%s\n' "${INSTALL[@]}" | sort | uniq) <(printf '%s\n' "${BREW_AVAILABLE_FORMULAE[@]}")))

        if [ "${#UNAVAILABLE[@]}" -gt "0" ]; then

            console_message "${#UNAVAILABLE[@]} $(single_or_plural "${#UNAVAILABLE[@]}" formula formulae) unavailable for installation:" "${UNAVAILABLE[*]}" "$BOLD" "$RED"

            INSTALL=($(comm -12 <(printf '%s\n' "${INSTALL[@]}" | sort | uniq) <(printf '%s\n' "${BREW_AVAILABLE_FORMULAE[@]}")))

            [ "${#INSTALL[@]}" -gt "0" ] || return 0

        fi

        if [ "$UI" = "Y" ]; then

            console_message "Missing $1 $(single_or_plural "${#INSTALL[@]}" formula formulae):" "${INSTALL[*]}" "$BOLD" "$MAGENTA"

            get_confirmation "Add the $1 $(single_or_plural "${#INSTALL[@]}" formula formulae) listed above?" Y Y || return 0

        fi

        BREW_FORMULAE_QUEUE+=("${INSTALL[@]}")

    fi

}

function brew_process_queue() {

    if [ "${#BREW_FORMULAE_QUEUE[@]}" -gt "0" ]; then

        console_message "Installing ${#BREW_FORMULAE_QUEUE[@]} $(single_or_plural "${#BREW_FORMULAE_QUEUE[@]}" formula formulae):" "${BREW_FORMULAE_QUEUE[*]}" "$GREEN"

        brew install "${BREW_FORMULAE_QUEUE[@]}" && {
            BREW_INSTALLED+=("${BREW_FORMULAE_QUEUE[@]}")
            BREW_JUST_INSTALLED+=("${BREW_FORMULAE_QUEUE[@]}")
        } || die

    fi

    BREW_FORMULAE_QUEUE=()
    brew_refresh

}

BREW_TAPS=(
    homebrew/cask-drivers
    homebrew/cask-fonts
    homebrew/cask-versions
)

BREW_CACHE_DIRTY=1
BREW_FORMULAE_QUEUE=()
BREW_INSTALLED=()
BREW_JUST_INSTALLED=()
