#!/bin/bash
# shellcheck disable=SC2034

# TODO: make all of this dynamic via external files

# 1080p
EDID_DISPLAY_0="00ffffffffffff00410c03c1b18e0000331b0103802c18782ac955a25750a126115054bd4b00d1c09500950fb30081c0818081400101023a801871382d40582c4500b3ef1000001e000000ff00554b3531373531303336353239000000fc0050484c203230305634510a2020000000fd00384c1e5311000a20202020202000af"

# 4K
EDID_DISPLAY_1="00ffffffffffff0005e39027182c0000041d0103803c22782a67a1a5554da2270e5054bfef00d1c0b30095008180814081c0010101014dd000a0f0703e803020350055502100001aa36600a0f0701f803020350055502100001a000000fc005532373930420a202020202020000000fd0017501ea03c000a2020202020200181020333f14c9004031f1301125d5e5f606123090707830100006d030c001000387820006001020367d85dc401788003e30f000c565e00a0a0a029503020350055502100001e023a801871382d40582c450055502100001e011d007251d01e206e28550055502100001e4d6c80a070703e8030203a0055502100001a000000004e"

EDID_DISPLAY_0_OPTIONS=()
EDID_DISPLAY_1_OPTIONS=()

for i in 0 1; do

    eval "EDID_DISPLAY_${i}_ACTIVE=0"

    if eval "EDID_DISPLAY_${i}_INDEX=\"\$(get_edid_index \"\$EDID_DISPLAY_${i}\")\""; then

        eval "EDID_DISPLAY_${i}_ACTIVE=1"

    fi

done

# 4K connected?
if [ "$EDID_DISPLAY_1_ACTIVE" -eq "1" ]; then

    # "looks like 2560x1440"
    EDID_DISPLAY_1_OPTIONS+=(--mode 3840x2160 --scale-from 5120x2880)

    # 1080p also connected?
    if [ "$EDID_DISPLAY_0_ACTIVE" -eq "1" ]; then

        # "looks like 1536x864" - i.e. use all of i915's (software-limited) 8192x8192 framebuffer
        EDID_DISPLAY_0_OPTIONS+=(--mode 1920x1080 --scale-from 3072x1728 --pos 0x576)
        EDID_DISPLAY_1_OPTIONS+=(--pos 3072x0)

    fi

fi

for i in 0 1; do

    eval "EDID_DISPLAY_ACTIVE=\"\$EDID_DISPLAY_${i}_ACTIVE\""

    if [ "$EDID_DISPLAY_ACTIVE" -eq "1" ]; then

        eval "EDID_DISPLAY_INDEX=\"\$EDID_DISPLAY_${i}_INDEX\""
        eval "OPTIONS_${EDID_DISPLAY_INDEX}+=(\"\${EDID_DISPLAY_${i}_OPTIONS[@]}\")"

    fi

done
